import { useContext, useEffect, useState } from "react";
import { useParams, useNavigate } from "react-router-dom";
import { formatISO9075 } from "date-fns";
import { UserContext } from "../UserContext";
import { Link } from "react-router-dom";

export default function PostPage() {
  const [postInfo, setPostInfo] = useState(null);
  const { userInfo } = useContext(UserContext);
  const { id } = useParams();
  const [isAuthor, setIsAuthor] = useState(false);
  const navigate = useNavigate();
  const [isPopupOpen, setIsPopupOpen] = useState(false);
  useEffect(() => {
    fetch(`http://localhost:4000/post/${id}`).then((response) => {
      response.json().then((postInfo) => {
        setPostInfo(postInfo);
      });
    });
  }, [id, userInfo]);
  const handleDelete = () => {
    fetch(`http://localhost:4000/post/${id}`, {
      method: "DELETE",
      credentials: "include",
    }).then(() => {
      navigate("/");
    });
  };
  if (!postInfo) return "";

  return (
    <div>
      <main className="pt-8 pb-16 lg:pt-16 lg:pb-24 font-Poppins ">
        <div className="flex justify-between px-4 mx-auto max-w-screen-xl ">
          <article className="mx-auto w-full max-w-2xl format format-sm sm:format-base lg:format-lg format-blue dark:format-invert">
            <div className="mb-4 lg:mb-6 not-format">
              <div className="sm:grid sm:grid-cols-2 ">
                <div className="flex flex-col gap-y-2">
                  <div className="">
                    <h1 className="sm:text-2xl font-bold text-gray-900 ">
                      <span>{postInfo.title}</span>
                      <svg
                        className="w-8 sm:w-10"
                        xmlns="http://www.w3.org/2000/svg"
                        x="0px"
                        y="0px"
                        viewBox="0 0 30 30"
                      >
                        <path d="M 3 11 C 2.5065428 11 2.0367533 11.205873 1.7050781 11.480469 C 1.373403 11.755065 1.1456345 12.082184 0.953125 12.423828 C 0.56810609 13.107116 0.31812456 13.882065 0.0703125 14.625 A 1.0001 1.0001 0 1 0 1.9667969 15.257812 C 2.2129848 14.519748 2.4600814 13.823712 2.6953125 13.40625 C 2.812928 13.197519 2.9253627 13.067107 2.9804688 13.021484 C 3.0355747 12.975862 2.9999572 13 3 13 C 3 13 2.9640854 12.975217 3.0214844 13.023438 C 3.0788834 13.071647 3.1929023 13.208552 3.3125 13.423828 C 3.5516954 13.85438 3.8007812 14.566406 4.0507812 15.316406 C 4.3007812 16.066406 4.5516954 16.85438 4.9375 17.548828 C 5.1304023 17.896052 5.3601338 18.227904 5.6933594 18.507812 C 6.0265853 18.78772 6.5 19 7 19 C 7.5 19 7.9734151 18.787722 8.3066406 18.507812 C 8.6398662 18.227904 8.8695977 17.896052 9.0625 17.548828 C 9.4483046 16.85438 9.6992188 16.066406 9.9492188 15.316406 C 10.199219 14.566406 10.448305 13.85438 10.6875 13.423828 C 10.807098 13.208552 10.921116 13.071652 10.978516 13.023438 C 11.035915 12.975221 11 13 11 13 C 11 13 10.964094 12.975217 11.021484 13.023438 C 11.078884 13.071647 11.192902 13.208552 11.3125 13.423828 C 11.551695 13.85438 11.800781 14.566406 12.050781 15.316406 C 12.300781 16.066406 12.551695 16.85438 12.9375 17.548828 C 13.130402 17.896052 13.360134 18.227904 13.693359 18.507812 C 14.026589 18.78772 14.5 19 15 19 C 15.5 19 15.973415 18.787722 16.306641 18.507812 C 16.639866 18.227904 16.869598 17.896052 17.0625 17.548828 C 17.448305 16.85438 17.699219 16.066406 17.949219 15.316406 C 18.199219 14.566406 18.448305 13.85438 18.6875 13.423828 C 18.807098 13.208552 18.921116 13.071652 18.978516 13.023438 C 19.035915 12.975221 19 13 19 13 C 19 13 18.964094 12.975217 19.021484 13.023438 C 19.078884 13.071647 19.192902 13.208552 19.3125 13.423828 C 19.551695 13.85438 19.800781 14.566406 20.050781 15.316406 C 20.300781 16.066406 20.551695 16.85438 20.9375 17.548828 C 21.130402 17.896052 21.360134 18.227904 21.693359 18.507812 C 22.026589 18.78772 22.5 19 23 19 C 23.5 19 23.973415 18.787722 24.306641 18.507812 C 24.639866 18.227904 24.869598 17.896052 25.0625 17.548828 C 25.448305 16.85438 25.699219 16.066406 25.949219 15.316406 C 26.199219 14.566406 26.448305 13.85438 26.6875 13.423828 C 26.807098 13.208552 26.921116 13.071652 26.978516 13.023438 C 27.035915 12.975221 27 13 27 13 C 27.000205 13 26.964291 12.975734 27.019531 13.021484 C 27.074771 13.067244 27.186985 13.199167 27.304688 13.408203 C 27.54009 13.826275 27.786993 14.523087 28.033203 15.261719 A 1.0005647 1.0005647 0 1 0 29.931641 14.628906 C 29.683852 13.885542 29.431972 13.109709 29.046875 12.425781 C 28.854326 12.083817 28.626746 11.75729 28.294922 11.482422 C 27.963098 11.207554 27.493795 11 27 11 C 26.5 11 26.026585 11.212277 25.693359 11.492188 C 25.360134 11.772096 25.130402 12.103948 24.9375 12.451172 C 24.551695 13.14562 24.300781 13.933594 24.050781 14.683594 C 23.800781 15.433594 23.551695 16.14562 23.3125 16.576172 C 23.192902 16.791448 23.078884 16.928347 23.021484 16.976562 C 22.964085 17.024779 23 17 23 17 C 23 17 23.035906 17.024783 22.978516 16.976562 C 22.921116 16.928342 22.807098 16.791448 22.6875 16.576172 C 22.448305 16.14562 22.199219 15.433594 21.949219 14.683594 C 21.699219 13.933594 21.448305 13.14562 21.0625 12.451172 C 20.869594 12.10395 20.639866 11.772096 20.306641 11.492188 C 19.973415 11.212277 19.5 11 19 11 C 18.5 11 18.026585 11.212277 17.693359 11.492188 C 17.360134 11.772096 17.130402 12.103948 16.9375 12.451172 C 16.551695 13.14562 16.300781 13.933594 16.050781 14.683594 C 15.800781 15.433594 15.551695 16.14562 15.3125 16.576172 C 15.192902 16.791448 15.078884 16.928347 15.021484 16.976562 C 14.964085 17.024779 15 17 15 17 C 15 17 15.035906 17.024783 14.978516 16.976562 C 14.921116 16.928342 14.807098 16.791448 14.6875 16.576172 C 14.448305 16.14562 14.199219 15.433594 13.949219 14.683594 C 13.699219 13.933594 13.448305 13.14562 13.0625 12.451172 C 12.869594 12.10395 12.639866 11.772096 12.306641 11.492188 C 11.973415 11.212277 11.5 11 11 11 C 10.5 11 10.026585 11.212277 9.6933594 11.492188 C 9.3601338 11.772096 9.1304023 12.103948 8.9375 12.451172 C 8.5516954 13.14562 8.3007812 13.933594 8.0507812 14.683594 C 7.8007812 15.433594 7.5516954 16.14562 7.3125 16.576172 C 7.1929023 16.791448 7.0788838 16.928347 7.0214844 16.976562 C 6.9640849 17.024779 7 17 7 17 C 7 17 7.0359146 17.024783 6.9785156 16.976562 C 6.9211158 16.928349 6.8070977 16.791448 6.6875 16.576172 C 6.4483046 16.14562 6.1992188 15.433594 5.9492188 14.683594 C 5.6992188 13.933594 5.4483046 13.14562 5.0625 12.451172 C 4.8695977 12.103948 4.6398662 11.772096 4.3066406 11.492188 C 3.9734151 11.212277 3.5 11 3 11 z"></path>
                      </svg>
                    </h1>
                  </div>
                  <p className="sm:text-xl gap-3 flex flex-row items-center font-light text-gray-500 dark:text-gray-400">
                    <svg
                      className="w-8 sm:w-10"
                      xmlns="http://www.w3.org/2000/svg"
                      x="0px"
                      y="0px"
                      viewBox="0 0 128 128"
                    >
                      <path d="M 64 4 C 38.6 4 18 24.6 18 50 C 18 63.8 24.100391 76.799609 34.900391 85.599609 C 43.000391 92.299609 53.4 96 64 96 C 89.4 96 110 75.4 110 50 C 110 24.6 89.4 4 64 4 z M 64 10 C 86.1 10 104 27.9 104 50 C 104 72.1 86.1 90 64 90 C 54.8 90 45.799219 86.8 38.699219 81 C 29.299219 73.3 24 62 24 50 C 24 27.9 41.9 10 64 10 z M 64 27 C 56.8 27 51 32.8 51 40 C 51 47.2 56.8 53 64 53 C 71.2 53 77 47.2 77 40 C 77 32.8 71.2 27 64 27 z M 64 33 C 67.9 33 71 36.1 71 40 C 71 43.9 67.9 47 64 47 C 60.1 47 57 43.9 57 40 C 57 36.1 60.1 33 64 33 z M 64 57 C 55.7 57 48.1 61.499609 44 68.599609 C 43.2 70.099609 43.699609 71.899219 45.099609 72.699219 C 45.599609 72.999219 46.099609 73.099609 46.599609 73.099609 C 47.599609 73.099609 48.699219 72.599219 49.199219 71.699219 C 52.199219 66.399219 57.9 63.099609 64 63.099609 C 70.1 63.099609 75.800781 66.399219 78.800781 71.699219 C 79.600781 73.099219 81.500391 73.600781 82.900391 72.800781 C 84.300391 72.000781 84.8 70.099219 84 68.699219 C 79.9 61.499219 72.3 57 64 57 z M 34 105 C 32.3 105 31 106.3 31 108 C 31 109.7 32.3 111 34 111 L 94 111 C 95.7 111 97 109.7 97 108 C 97 106.3 95.7 105 94 105 L 34 105 z M 44 120 C 42.3 120 41 121.3 41 123 C 41 124.7 42.3 126 44 126 L 63 126 C 64.7 126 66 124.7 66 123 C 66 121.3 64.7 120 63 120 L 44 120 z M 79 120 C 77.3 120 76 121.3 76 123 C 76 124.7 77.3 126 79 126 L 84 126 C 85.7 126 87 124.7 87 123 C 87 121.3 85.7 120 84 120 L 79 120 z"></path>
                    </svg>
                    <span> by @{postInfo.author.username}</span>
                  </p>
                  <div>
                    <p className="sm:text-xl   gap-3 font-light flex flex-row items-center text-gray-500 dark:text-gray-400">
                      <svg
                        className="w-8 sm:w-10"
                        xmlns="http://www.w3.org/2000/svg"
                        x="0px"
                        y="0px"
                        viewBox="0 0 50 50"
                      >
                        <path d="M 12 0 C 10.90625 0 10 0.90625 10 2 L 10 4 L 4 4 C 3.476563 4 2.945313 4.191406 2.570313 4.570313 C 2.191406 4.945313 2 5.476563 2 6 L 2 46 C 2 46.523438 2.191406 47.054688 2.570313 47.433594 C 2.945313 47.808594 3.476563 48 4 48 L 46 48 C 46.523438 48 47.054688 47.808594 47.433594 47.433594 C 47.808594 47.054688 48 46.523438 48 46 L 48 6 C 48 5.476563 47.808594 4.945313 47.433594 4.570313 C 47.054688 4.191406 46.523438 4 46 4 L 40 4 L 40 2 C 40 0.90625 39.09375 0 38 0 L 36 0 C 34.90625 0 34 0.90625 34 2 L 34 4 L 16 4 L 16 2 C 16 0.90625 15.09375 0 14 0 Z M 12 2 L 14 2 L 14 8 L 12 8 Z M 36 2 L 38 2 L 38 8 L 36 8 Z M 4 6 L 10 6 L 10 8 C 10 9.09375 10.90625 10 12 10 L 14 10 C 15.09375 10 16 9.09375 16 8 L 16 6 L 34 6 L 34 8 C 34 9.09375 34.90625 10 36 10 L 38 10 C 39.09375 10 40 9.09375 40 8 L 40 6 L 46 6 L 46 13 L 4 13 Z M 4 15 L 46 15 L 46 46 L 4 46 Z M 10 19 L 10 42 L 40 42 L 40 19 Z M 12 21 L 17 21 L 17 26 L 12 26 Z M 19 21 L 24 21 L 24 26 L 19 26 Z M 26 21 L 31 21 L 31 26 L 26 26 Z M 33 21 L 38 21 L 38 26 L 33 26 Z M 12 28 L 17 28 L 17 33 L 12 33 Z M 19 28 L 24 28 L 24 33 L 19 33 Z M 26 28 L 31 28 L 31 33 L 26 33 Z M 33 28 L 38 28 L 38 33 L 33 33 Z M 12 35 L 17 35 L 17 40 L 12 40 Z M 19 35 L 24 35 L 24 40 L 19 40 Z M 26 35 L 31 35 L 31 40 L 26 40 Z M 33 35 L 38 35 L 38 40 L 33 40 Z"></path>
                      </svg>
                      <time>{formatISO9075(new Date(postInfo.createdAt))}</time>
                    </p>
                  </div>
                </div>

                <div>
                  {userInfo.id === postInfo.author._id && (
                    <div className="flex flex-row gap-x-3 justify-end">
                      <Link to={`/edit/${postInfo._id}`}>
                        <svg
                          className=" w-8 sm:w-10 hover:fill-red-500"
                          xmlns="http://www.w3.org/2000/svg"
                          x="0px"
                          y="0px"
                          viewBox="0 0 50 50"
                        >
                          <path d="M 36.90625 -0.0625 C 35.859375 -0.0625 34.828125 0.328125 34.03125 1.125 L 33.71875 1.4375 C 33.671875 1.476563 33.632813 1.515625 33.59375 1.5625 L 33.34375 1.84375 L 17.84375 17.3125 C 17.722656 17.433594 17.636719 17.585938 17.59375 17.75 L 15.96875 23.75 C 15.875 24.101563 15.976563 24.472656 16.234375 24.726563 C 16.496094 24.980469 16.871094 25.070313 17.21875 24.96875 L 23.1875 23.34375 C 23.363281 23.304688 23.527344 23.21875 23.65625 23.09375 L 39.125 7.625 C 39.125 7.625 39.261719 7.488281 39.375 7.375 C 39.421875 7.328125 39.464844 7.273438 39.5 7.21875 C 39.652344 7.066406 39.8125 6.90625 39.8125 6.90625 C 41.410156 5.308594 41.40625 2.71875 39.8125 1.125 C 39.015625 0.328125 37.953125 -0.0625 36.90625 -0.0625 Z M 34.75 3.25 L 37.6875 6.1875 L 22.375 21.53125 L 19.4375 18.625 L 19.46875 18.5 Z M 3 9 C 1.347656 9 0 10.347656 0 12 L 0 38 C 0 39.652344 1.347656 41 3 41 L 47 41 C 48.652344 41 50 39.652344 50 38 L 50 12 C 50 10.347656 48.652344 9 47 9 L 39.71875 9 L 37.71875 11 L 47 11 C 47.550781 11 48 11.449219 48 12 L 48 38 C 48 38.550781 47.550781 39 47 39 L 3 39 C 2.449219 39 2 38.550781 2 38 L 2 12 C 2 11.449219 2.449219 11 3 11 L 22.125 11 L 24.125 9 Z"></path>
                        </svg>
                      </Link>
                      {isAuthor && (
                        <button
                          onClick={() => setIsPopupOpen(true)}
                          className="bg-red-500 text-white px-4 py-2"
                        >
                          Delete Post
                        </button>
                      )}
                      <button onClick={() => setIsPopupOpen(true)}>
                        <svg
                          className=" w-8 sm:w-10 hover:fill-red-500"
                          xmlns="http://www.w3.org/2000/svg"
                          x="0px"
                          y="0px"
                          viewBox="0 0 50 50"
                        >
                          <path d="M 13.599609 4 C 8.8620649 4 5 7.8620649 5 12.599609 L 5 30.599609 L 5 31.400391 L 5 38.400391 C 5 43.137935 8.8620649 47 13.599609 47 L 36.400391 47 C 41.137935 47 45 43.137935 45 38.400391 L 45 31.400391 L 45 30.599609 L 45 12.599609 C 45 7.8620649 41.137935 4 36.400391 4 L 13.599609 4 z M 13.599609 6 L 36.400391 6 C 40.056846 6 43 8.9431546 43 12.599609 L 43 30.599609 L 43 31.400391 C 43 35.056846 40.056846 38 36.400391 38 L 13.599609 38 C 9.9431546 38 7 35.056846 7 31.400391 L 7 30.599609 L 7 12.599609 C 7 8.9431546 9.9431546 6 13.599609 6 z M 33.458984 16.365234 L 33.458984 26.734375 L 35.154297 26.734375 L 35.154297 16.365234 L 33.458984 16.365234 z M 14.960938 16.871094 L 14.960938 26.736328 L 18.658203 26.736328 C 21.612203 26.736328 23.300781 24.924766 23.300781 21.759766 C 23.300781 18.662766 21.591203 16.871094 18.658203 16.871094 L 14.960938 16.871094 z M 16.724609 18.394531 L 18.427734 18.394531 C 20.361734 18.394531 21.503906 19.632156 21.503906 21.785156 C 21.503906 23.986156 20.389734 25.210938 18.427734 25.210938 L 16.724609 25.210938 L 16.724609 18.394531 z M 28.277344 19.105469 C 26.110344 19.105469 24.763672 20.617437 24.763672 23.023438 C 24.763672 25.429438 26.090016 26.884766 28.291016 26.884766 C 30.054016 26.884766 31.292281 26.037734 31.613281 24.677734 L 30.007812 24.677734 C 29.761813 25.230734 29.180844 25.537109 28.339844 25.537109 C 27.225844 25.537109 26.507797 24.759625 26.466797 23.515625 L 26.466797 23.425781 L 31.689453 23.425781 L 31.689453 22.878906 C 31.689453 20.520906 30.410344 19.105469 28.277344 19.105469 z M 28.271484 20.453125 C 29.290484 20.453125 29.960141 21.164484 29.994141 22.271484 L 26.472656 22.271484 C 26.547656 21.177484 27.259484 20.453125 28.271484 20.453125 z M 7 36.902344 C 8.5794631 38.792759 10.952573 40 13.599609 40 L 36.400391 40 C 39.047427 40 41.420537 38.792759 43 36.902344 L 43 38.400391 C 43 42.056846 40.056846 45 36.400391 45 L 13.599609 45 C 9.9431546 45 7 42.056846 7 38.400391 L 7 36.902344 z"></path>
                        </svg>
                      </button>
                      {isPopupOpen && (
                        <div className="fixed z-10 inset-0 overflow-y-auto">
                          <div className="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                            <div className="fixed inset-0 transition-opacity">
                              <div className="absolute inset-0 bg-gray-500 opacity-75"></div>
                            </div>
                            <span
                              className="hidden sm:inline-block sm:align-middle sm:h-screen"
                              aria-hidden="true"
                            >
                              &#8203;
                            </span>
                            <div
                              className="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6"
                              role="dialog"
                              aria-modal="true"
                              aria-labelledby="modal-headline"
                            >
                              <div>
                                <div className="mt-3 text-center sm:mt-5">
                                  <h3
                                    className="text-lg leading-6 font-medium text-gray-900"
                                    id="modal-headline"
                                  >
                                    Delete Post
                                  </h3>
                                  <div className="mt-2">
                                    <p className="text-sm leading-5 text-gray-500">
                                      Are you sure you want to delete this post?
                                      This action cannot be undone.
                                    </p>
                                  </div>
                                </div>
                              </div>
                              <div className="mt-5 sm:mt-6">
                                <span className="flex w-full rounded-md shadow-sm">
                                  <button
                                    onClick={() => setIsPopupOpen(false)}
                                    type="button"
                                    className="inline-flex justify-center w-full rounded-md border border-transparent px-4 py-2 bg-gray-300 text-base leading-6 font-medium text-gray-700 hover:bg-gray-200 focus:outline-none focus:border-blue-700 focus:shadow-outline-blue transition ease-in-out duration-150 sm:text-sm sm:leading-5 mr-2"
                                  >
                                    Cancel
                                  </button>
                                  <button
                                    onClick={() => {
                                      setIsPopupOpen(false);
                                      handleDelete();
                                    }}
                                    type="button"
                                    className="inline-flex justify-center w-full rounded-md border border-transparent px-4 py-2 bg-red-600 text-base leading-6 font-medium text-white hover:bg-red-500 focus:outline-none focus:border-red-700 focus:shadow-outline-red transition ease-in-out duration-150 sm:text-sm sm:leading-5"
                                  >
                                    Delete
                                  </button>
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>
            </div>
            <div className="flex flex-col gap-y-4">
              <div>
                <img
                  className="w-1/2  mx-auto block"
                  src={`http://localhost:4000/${postInfo.cover}`}
                  alt=""
                />
              </div>
              <div
                className=" leading-tight text-gray-900 border p-4  "
                dangerouslySetInnerHTML={{ __html: postInfo.content }}
              />
            </div>
          </article>
          <div />
        </div>
      </main>
    </div>
  );
}
